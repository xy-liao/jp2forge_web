{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Job Details | JP2Forge Web{% endblock %}

{% block extra_css %}
<style>
    .metrics-table th {
        width: 40%;
    }
    .progress {
        height: 24px;
        margin-bottom: 10px;
        border-radius: 12px;
        background-color: #f0f0f0;
        box-shadow: inset 0 1px 3px rgba(0,0,0,.1);
        overflow: hidden;
    }
    .progress-bar {
        transition: width 0.5s ease;
        background-image: linear-gradient(45deg, 
                          rgba(255,255,255,.15) 25%, transparent 25%, 
                          transparent 50%, rgba(255,255,255,.15) 50%, 
                          rgba(255,255,255,.15) 75%, transparent 75%, 
                          transparent);
        background-size: 1rem 1rem;
        animation: progress-bar-stripes 1s linear infinite;
    }
    @keyframes progress-bar-stripes {
        from { background-position: 1rem 0 }
        to { background-position: 0 0 }
    }
    .file-card {
        transition: all 0.3s ease;
    }
    .file-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .status-badge {
        font-size: 1rem;
    }
    .metrics-section {
        display: none;
    }
    .progress-details {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }
    .conversion-steps {
        margin-top: 15px;
        margin-bottom: 10px;
    }
    .step-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        padding: 8px;
        border-radius: 4px;
        background-color: #f8f9fa;
        transition: background-color 0.3s ease;
    }
    .step-item.active {
        background-color: #e3f2fd;
        border-left: 3px solid #0d6efd;
    }
    .step-item.completed {
        background-color: #e8f5e9;
        border-left: 3px solid #28a745;
    }
    .step-icon {
        margin-right: 12px;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .step-info {
        flex-grow: 1;
    }
    .progress-percentage {
        font-weight: bold;
        font-size: 1.1rem;
        transition: color 0.3s ease;
    }
    .text-highlight {
        color: #0d6efd;
        animation: highlight-pulse 0.5s ease;
    }
    @keyframes highlight-pulse {
        0% { color: #0d6efd; transform: scale(1); }
        50% { color: #0dcaf0; transform: scale(1.1); }
        100% { color: #0d6efd; transform: scale(1); }
    }
    .estimated-time {
        font-style: italic;
        color: #6c757d;
        font-size: 0.85rem;
    }

    /* Badge styling for consistent categories */
    .badge-container {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 6px;
    }
    
    .badge {
        padding: 6px 10px;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 4px;
    }
    
    /* Simplified badge colors - just two types */
    .badge-primary {
        background-color: #0d6efd !important;
        color: #fff;
    }
    
    .badge-detail {
        background-color: #6c757d !important;
        color: #fff;
        opacity: 0.85;
    }
    
    /* Special states that need to retain their meaning */
    .badge-success {
        background-color: #198754 !important;
        color: #fff;
    }
    
    .badge-warning {
        background-color: #ffc107 !important;
        color: #212529;
    }
    
    .badge-danger {
        background-color: #dc3545 !important;
        color: #fff;
    }
    
    /* Info icon styling */
    .info-icon {
        opacity: 0.7;
        cursor: help;
        margin-left: 5px;
        font-size: 0.8rem;
    }

    /* Styling for conversion settings */
    .conversion-settings th {
        width: 30%;
        vertical-align: middle;
        padding: 12px 15px;
        background-color: rgba(0,0,0,0.03);
        border-right: 1px solid #dee2e6;
    }
    
    .conversion-settings td {
        vertical-align: middle;
        padding: 12px 15px;
    }

    /* Badge theming */
    .badge.bg-primary {
        background-color: #0d6efd !important;
    }
    
    .badge.bg-info {
        background-color: #5bc0de !important;
        color: #fff;
    }
    
    .badge.bg-success {
        background-color: #198754 !important;
    }
    
    .badge.bg-warning {
        background-color: #ffc107 !important;
        color: #212529;
    }
    
    .badge.bg-secondary {
        background-color: #6c757d !important;
        opacity: 0.85;
    }

    /* Info icon styling */
    .info-icon {
        opacity: 0.6;
        cursor: help;
        margin-left: 6px;
        transition: opacity 0.2s;
    }
    
    .info-icon:hover {
        opacity: 1;
    }

    /* New styles for optimized file display */
    .files-pagination {
        display: flex;
        justify-content: center;
        margin: 15px 0;
    }
    
    .page-item.active .page-link {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .files-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        grid-gap: 10px;
        margin-bottom: 15px;
    }
    
    .file-item {
        text-align: center;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 10px 5px;
        cursor: pointer;
        position: relative;
        transition: all 0.2s ease;
    }
    
    .file-item:hover {
        background-color: #f8f9fa;
        transform: translateY(-3px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .file-item.selected {
        background-color: #e3f2fd;
        border-color: #0d6efd;
    }
    
    .file-checkbox {
        position: absolute;
        top: 5px;
        left: 5px;
        z-index: 1;
    }
    
    .file-icon {
        font-size: 2rem;
        margin-bottom: 5px;
        color: #0d6efd;
    }
    
    .file-name {
        font-size: 0.8rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin-top: 5px;
        max-width: 100%;
    }
    
    .file-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .file-selection {
        display: flex;
        align-items: center;
    }
    
    .file-filters {
        display: flex;
        align-items: center;
    }
    
    .nav-tabs {
        margin-bottom: 15px;
    }
    
    .batch-actions {
        margin-top: 10px;
        display: none;
    }
    
    .batch-actions.show {
        display: block;
    }
    
    .preview-pane {
        text-align: center;
        margin-top: 15px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    
    .preview-image {
        max-width: 100%;
        max-height: 300px;
        object-fit: contain;
    }
    
    .tab-content {
        padding-top: 15px;
    }

    /* Visual quality indicator */
    .quality-indicator {
        height: 6px;
        margin: 10px 0 15px 0;
        background: linear-gradient(to right, #dc3545, #ffc107, #198754);
        border-radius: 3px;
        position: relative;
        width: 100%;
    }
    
    /* Quality marker/indicator */
    .quality-marker {
        position: absolute;
        width: 14px;
        height: 14px;
        background-color: #212529;
        border-radius: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        z-index: 2;
        cursor: pointer;
        transition: transform 0.1s ease;
    }
    
    [data-bs-theme="dark"] .quality-marker {
        background-color: #f8f9fa;
    }
    
    .quality-marker:hover {
        transform: translate(-50%, -50%) scale(1.2);
    }
    
    .quality-marker:active {
        transform: translate(-50%, -50%) scale(0.9);
        cursor: grabbing;
    }
    
    /* Style for quality range indicator texts */
    .quality-label-container {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }
    
    .quality-label-container span {
        color: #6c757d;
        font-size: 0.875rem;
    }
    
    [data-bs-theme="dark"] .quality-label-container span {
        color: #adb5bd;
    }
    
    .quality-value {
        font-size: 1.1rem;
        font-weight: 500;
        margin-bottom: 5px;
        transition: all 0.2s ease;
    }
    
    .quality-display {
        padding-right: 15px;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="row mb-4">
    <div class="col-md-8">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'job_list' %}">Jobs</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ job.original_filename }}</li>
            </ol>
        </nav>
        <h1>Job Details</h1>
    </div>
    <div class="col-md-4 text-end">
        {% if job.status == 'completed' and job.result_file %}
            {% if output_files %}
                <!-- If there are multiple output files, use the download-all functionality for the main button -->
                <a href="{% url 'job_download_all' job.id %}" class="btn btn-success btn-action">
                    <i class="bi bi-download"></i> Download All
                </a>
            {% else %}
                <!-- If there's just one file, link directly to it -->
                <a href="{{ job.result_file.url }}" class="btn btn-success btn-action" download>
                    <i class="bi bi-download"></i> Download
                </a>
            {% endif %}
        {% endif %}
        <a href="{% url 'job_delete' job.id %}" class="btn btn-danger btn-action">
            <i class="bi bi-trash"></i> Delete
        </a>
    </div>
</div>

<div class="row">
    <!-- Job Information -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    {{ job.original_filename }}
                </h5>
                <span id="job-status-badge" class="status-badge badge bg-{{ job.status|yesno:'success,danger,primary,secondary' }}">
                    {{ job.get_status_display }}
                </span>
            </div>
            <div class="card-body">
                <!-- Status Information -->
                <div id="job-status-section" {% if job.status != 'processing' %}style="display: none;"{% endif %}>
                    <div class="alert alert-info mb-3">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="bi bi-arrow-repeat fs-3 me-2"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">Converting: <span class="text-primary">{{ job.original_filename }}</span></h6>
                                <p class="mb-0">Your file is currently being processed. This page will update automatically when complete.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Message (if any) -->
                <div id="error-message" class="alert alert-danger" {% if not job.error_message %}style="display: none;"{% endif %}>
                    {{ job.error_message }}
                </div>

                <!-- Job Details -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>Job Information</h6>
                        <table class="table">
                            <tr>
                                <th>Job ID</th>
                                <td>{{ job.id }}</td>
                            </tr>
                            <tr>
                                <th>Created</th>
                                <td>{{ job.created_at }}</td>
                            </tr>
                            <tr>
                                <th>Updated</th>
                                <td>{{ job.updated_at }}</td>
                            </tr>
                            <tr>
                                <th>Completed</th>
                                <td id="completed-at">{{ job.completed_at|default:"Not completed yet" }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Conversion Settings</h6>
                        <table class="table">
                            <tr>
                                <th>Compression Mode</th>
                                <td>
                                    <div class="badge-container">
                                        {% if job.compression_mode == 'lossless' %}
                                            <span class="badge badge-primary">Lossless</span>
                                            <span class="badge badge-detail">No quality loss</span>
                                        {% elif job.compression_mode == 'lossy' %}
                                            <span class="badge badge-primary">Lossy</span>
                                            <span class="badge badge-detail">Quality {{ job.quality }}</span>
                                        {% elif job.compression_mode == 'supervised' %}
                                            <span class="badge badge-primary">Supervised</span>
                                            <span class="badge badge-detail">Quality {{ job.quality }}</span>
                                        {% elif job.compression_mode == 'bnf_compliant' %}
                                            <span class="badge badge-primary">BnF Compliant</span>
                                            <span class="badge badge-detail">Specialized preset</span>
                                        {% else %}
                                            {{ job.compression_mode|default:"Unknown" }}
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>Document Type</th>
                                <td>
                                    <div class="badge-container">
                                        {% if job.document_type == 'photograph' %}
                                            <span class="badge badge-primary">Photograph</span>
                                        {% elif job.document_type == 'heritage_document' %}
                                            <span class="badge badge-primary">Heritage Document</span>
                                        {% elif job.document_type == 'color' %}
                                            <span class="badge badge-primary">Color</span>
                                        {% elif job.document_type == 'grayscale' %}
                                            <span class="badge badge-primary">Grayscale</span>
                                        {% else %}
                                            {{ job.document_type|default:"Not specified" }}
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>
                                    BnF Mode
                                    <i class="bi bi-info-circle info-icon" data-bs-toggle="tooltip" title="Indicates how BnF compliance was applied to this job"></i>
                                </th>
                                <td>
                                    <div class="badge-container">
                                        {% if job.metrics.bnf_validation.is_compliant == "true" or job.metrics.bnf_compliance.is_compliant == "true" or job.metrics.bnf_compression_compliant == "true" %}
                                            {% if job.compression_mode == 'bnf_compliant' %}
                                                <span class="badge badge-primary">Auto</span>
                                            {% else %}
                                                <span class="badge badge-primary">Manual</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge badge-detail">No</span>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>
                                    BnF Compliance
                                    <i class="bi bi-info-circle info-icon" data-bs-toggle="tooltip" title="Shows whether the final output meets BnF standards (including fallback strategy)"></i>
                                </th>
                                <td>
                                    <div class="badge-container">
                                        {% if job.status == 'completed' %}
                                            {% if job.metrics.bnf_validation.checks.compression_ratio.passed == "true" %}
                                                <span class="badge badge-success">Passed</span>
                                                {% if job.metrics.bnf_validation.checks.compression_ratio.actual < job.metrics.bnf_validation.checks.compression_ratio.expected %}
                                                    <span class="badge badge-detail">Lossless Fallback</span>
                                                {% endif %}
                                            {% elif job.metrics.bnf_validation.is_compliant == "true" %}
                                                <span class="badge badge-success">Passed</span>
                                                {% if job.metrics.bnf_validation.checks.compression_ratio.actual < job.metrics.bnf_validation.checks.compression_ratio.expected %}
                                                    <span class="badge badge-detail">Lossless Fallback</span>
                                                {% endif %}
                                            {% elif job.metrics.bnf_compression_compliant or job.metrics.bnf_compliance.is_compliant == "true" %}
                                                <span class="badge badge-success">Passed</span>
                                                {% if job.document_type == 'heritage_document' or job.document_type == 'photograph' %}
                                                    {% if job.compression_ratio < 3.8 %}
                                                        <span class="badge badge-detail">Lossless Fallback</span>
                                                    {% endif %}
                                                {% elif job.document_type == 'color' %}
                                                    {% if job.compression_ratio < 5.7 %}
                                                        <span class="badge badge-detail">Lossless Fallback</span>
                                                    {% endif %}
                                                {% elif job.document_type == 'grayscale' %}
                                                    {% if job.compression_ratio < 15.2 %}
                                                        <span class="badge badge-detail">Lossless Fallback</span>
                                                    {% endif %}
                                                {% endif %}
                                            {% else %}
                                                <span class="badge badge-danger">Failed</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge badge-detail">N/A</span>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>
                                    Target Ratio
                                    <i class="bi bi-info-circle info-icon" data-bs-toggle="tooltip" title="Indicates whether the specific target compression ratio was achieved directly"></i>
                                </th>
                                <td>
                                    <div class="badge-container">
                                        {% if job.status == 'completed' %}
                                            {% if job.metrics.bnf_validation.is_compliant == "true" or job.metrics.bnf_compliance.is_compliant == "true" or job.metrics.bnf_compression_compliant == "true" or job.bnf_compliant %}
                                                {% if job.metrics.bnf_compliance.is_compliant == "true" %}
                                                    <span class="badge badge-success">Yes</span>
                                                    <span class="badge badge-detail">{{ job.compression_ratio }}:1 â‰¥ {{ job.metrics.bnf_compliance.target_ratio }}:1</span>
                                                {% elif job.compression_mode == 'bnf_compliant' and job.metrics.bnf_validation.checks.compression_ratio %}
                                                    <span class="badge badge-danger">No</span>
                                                    <span class="badge badge-detail">{{ job.compression_ratio }}:1 < {{ job.metrics.bnf_validation.checks.compression_ratio.expected }}:1</span>
                                                {% else %}
                                                    <span class="badge badge-danger">No</span>
                                                    {% if job.document_type == 'photograph' or job.document_type == 'heritage_document' %}
                                                        <span class="badge badge-detail">{{ job.compression_ratio }}:1 < 4:1</span>
                                                    {% elif job.document_type == 'color' %}
                                                        <span class="badge badge-detail">{{ job.compression_ratio }}:1 < 6:1</span>
                                                    {% elif job.document_type == 'grayscale' %}
                                                        <span class="badge badge-detail">{{ job.compression_ratio }}:1 < 16:1</span>
                                                    {% endif %}
                                                {% endif %}
                                            {% else %}
                                                <span class="badge badge-detail">N/A</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge badge-detail">N/A</span>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>Quality Setting</th>
                                <td>{{ job.quality|default:"40" }}</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- File Details -->
                <div class="row mb-3">
                    <div class="col-12">
                        <h6>File Information</h6>
                        <table class="table">
                            <tr>
                                <th>Original File</th>
                                <td>
                                    {{ job.original_filename }}
                                    {% if job.original_file %}
                                    <a href="{{ job.original_file.url }}" class="btn btn-sm btn-outline-success ms-2 btn-action-sm" download>
                                        <i class="bi bi-download"></i> Download
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Output File{% if output_files %}s{% endif %}</th>
                                <td id="output-filename">
                                    {% if output_files %}
                                        {{ output_files|length|add:"1" }} JP2 files generated
                                        <a href="{% url 'job_download_all' job.id %}" class="btn btn-sm btn-success ms-2 btn-action-sm">
                                            <i class="bi bi-download"></i> Download All JP2 Files
                                        </a>
                                    {% else %}
                                        {{ job.output_filename|default:"Not generated yet" }}
                                        {% if job.result_file %}
                                        <a href="{{ job.result_file.url }}" class="btn btn-sm btn-success ms-2 btn-action-sm" download>
                                            <i class="bi bi-download"></i> Download JP2
                                        </a>
                                        {% endif %}
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Original Size</th>
                                <td>{{ job.original_size|filesizeformat|default:"Unknown" }}</td>
                            </tr>
                            <tr>
                                <th>Converted Size</th>
                                <td id="converted-size">{{ job.converted_size|filesizeformat|default:"Not available yet" }}</td>
                            </tr>
                            <tr>
                                <th>Compression Ratio</th>
                                <td id="compression-ratio">
                                    {% if job.compression_ratio %}{{ job.compression_ratio }}:1{% else %}Not available yet{% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Quality Metrics (shown only if available) -->
                <div id="metrics-section" class="metrics-section" {% if not job.metrics %}style="display: none;"{% endif %}>
                    <h6>Quality Metrics</h6>
                    <table class="table metrics-table">
                        <tbody id="metrics-table-body">
                            {% for key, value in job.metrics.items %}
                            <tr>
                                <th>{{ key|title }}</th>
                                <td>{{ value }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Output Files Section -->
    <div class="col-md-4">
        <!-- Output Files List -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Output Files</h5>
                {% if job.status == 'completed' and job.result_file %}
                <a href="{% url 'job_download_all' job.id %}" class="btn btn-success btn-action-sm">
                    <i class="bi bi-file-earmark-zip"></i> Download All
                </a>
                {% endif %}
            </div>
            <div class="card-body">
                {% if job.status == 'completed' and job.result_file %}
                
                <!-- File selection and actions toolbar -->
                <div class="file-actions mb-3">
                    <div class="file-selection">
                        <div class="form-check me-3">
                            <input class="form-check-input" type="checkbox" id="select-all-files">
                            <label class="form-check-label" for="select-all-files">Select All</label>
                        </div>
                    </div>
                    <div class="file-filters">
                        <span class="badge bg-primary rounded-pill ms-2" id="file-count">
                            {{ output_files|length|add:"1" }} files
                        </span>
                        
                        <!-- Download structure toggle option -->
                        <div class="form-check form-switch ms-3 d-inline-block">
                            <input class="form-check-input" type="checkbox" id="flat-structure-toggle">
                            <label class="form-check-label" for="flat-structure-toggle">Flat structure</label>
                            <span class="ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="When enabled, files will be downloaded in a flat structure instead of folders.">
                                <i class="bi bi-question-circle-fill text-muted small"></i>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Selected files actions -->
                <div class="batch-actions" id="batch-actions">
                    <button class="btn btn-sm btn-success" id="batch-download-btn">
                        <i class="bi bi-download"></i> Download Selected
                    </button>
                </div>

                <!-- Files Grid View -->
                <div class="files-grid mb-3" id="files-grid">
                    <!-- Main output file -->
                    <div class="file-item" data-url="{{ job.result_file.url }}">
                        <input type="checkbox" class="form-check-input file-checkbox">
                        <div class="file-icon">
                            <i class="bi bi-file-earmark-image"></i>
                        </div>
                        <div class="file-name" title="{{ job.output_filename }}">{{ job.output_filename }}</div>
                    </div>
                    
                    <!-- Additional output files -->
                    {% for file in output_files %}
                    <div class="file-item" data-url="{{ file.url }}">
                        <input type="checkbox" class="form-check-input file-checkbox">
                        <div class="file-icon">
                            <i class="bi bi-file-earmark-image"></i>
                        </div>
                        <div class="file-name" title="{{ file.name }}">{{ file.name }}</div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination for large number of files -->
                {% if output_files|length > 11 %}
                <nav aria-label="Files pagination">
                    <ul class="pagination files-pagination" id="files-pagination">
                        <!-- Pagination will be generated by JavaScript -->
                    </ul>
                </nav>
                {% endif %}
                
                {% else %}
                <p class="text-muted">No output files available yet</p>
                {% endif %}
            </div>
        </div>

        <!-- Report (if available) -->
        {% if report_path %}
        <div class="card">
            <div class="card-header">
                <h5>Conversion Report</h5>
            </div>
            <div class="card-body">
                <a href="{{ report_path }}" class="btn btn-outline-info w-100" download>
                    <i class="bi bi-file-earmark-text"></i> Download Report
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // File display management
    const ITEMS_PER_PAGE = 12;
    let currentPage = 1;
    let fileItems = [];
    let selectedFiles = [];
    
    // Job status polling function
    function pollJobStatus() {
        // Only poll for pending or processing jobs
        const statusBadge = document.getElementById('job-status-badge');
        if (!statusBadge || 
            (statusBadge.textContent.trim() !== 'Pending' && 
             statusBadge.textContent.trim() !== 'Processing')) {
            return;
        }
        
        // Poll the job status
        fetch('{% url "job_status" job.id %}')
            .then(response => response.json())
            .then(data => {
                // Update status badge
                if (statusBadge) {
                    // Use utility function to update the badge
                    updateStatusBadge(statusBadge, data.status);
                }
                
                // Show/hide status section based on status
                const statusSection = document.getElementById('job-status-section');
                if (statusSection) {
                    statusSection.style.display = data.status === 'processing' ? 'block' : 'none';
                }
                
                // Update output filename if available
                const outputFilename = document.getElementById('output-filename');
                if (outputFilename && data.output_filename) {
                    outputFilename.textContent = data.output_filename;
                    
                    // Add download button if not already present
                    if (data.status === 'completed' && !outputFilename.querySelector('.btn')) {
                        const downloadBtn = document.createElement('a');
                        downloadBtn.href = data.result_file;
                        downloadBtn.className = 'btn btn-sm btn-success ms-2 btn-action-sm';
                        downloadBtn.download = true;
                        downloadBtn.innerHTML = '<i class="bi bi-download"></i> Download JP2';
                        outputFilename.appendChild(downloadBtn);
                    }
                }
                
                // Update completion time if available
                const completedAt = document.getElementById('completed-at');
                if (completedAt && data.completed_at) {
                    const date = new Date(data.completed_at);
                    completedAt.textContent = date.toLocaleString();
                }
                
                // Update metrics if available
                if (data.formatted_metrics && Object.keys(data.formatted_metrics).length > 0) {
                    const metricsSection = document.getElementById('metrics-section');
                    const metricsTableBody = document.getElementById('metrics-table-body');
                    
                    if (metricsSection && metricsTableBody) {
                        metricsSection.style.display = 'block';
                        metricsTableBody.innerHTML = '';
                        
                        for (const [key, value] of Object.entries(data.formatted_metrics)) {
                            // Skip current_step as we're not showing steps anymore
                            if (key === 'current_step') continue;
                            
                            const row = document.createElement('tr');
                            
                            const keyCell = document.createElement('th');
                            keyCell.textContent = key.charAt(0).toUpperCase() + key.slice(1).replace('_', ' ');
                            
                            const valueCell = document.createElement('td');
                            valueCell.textContent = value;
                            
                            row.appendChild(keyCell);
                            row.appendChild(valueCell);
                            metricsTableBody.appendChild(row);
                        }
                    }
                    
                    // Update BnF compliance badge if job is completed and was BnF compliant request
                    if (data.status === 'completed') {
                        // Find the BnF Compliance row by looking for the header text
                        const bnfComplianceHeaders = Array.from(document.querySelectorAll('th')).filter(
                            th => th.textContent.trim().startsWith('BnF Compliance')
                        );
                        
                        if (bnfComplianceHeaders.length > 0) {
                            const bnfComplianceBadgeContainer = bnfComplianceHeaders[0].nextElementSibling.querySelector('.badge-container');
                            
                            if (bnfComplianceBadgeContainer) {
                                // Clear existing badges
                                bnfComplianceBadgeContainer.innerHTML = '';
                                
                                let isCompliant = false;
                                let useFallback = false;
                                let targetRatio = 0;
                                let actualRatio = 0;
                                
                                // Check all possible sources of compliance data
                                if (data.formatted_metrics && data.formatted_metrics.bnf_validation) {
                                    // Primary source: bnf_validation
                                    isCompliant = data.formatted_metrics.bnf_validation.is_compliant === "true";
                                    
                                    // Check if using fallback strategy
                                    if (data.formatted_metrics.bnf_validation.checks && 
                                        data.formatted_metrics.bnf_validation.checks.compression_ratio) {
                                        targetRatio = data.formatted_metrics.bnf_validation.checks.compression_ratio.expected;
                                        actualRatio = data.formatted_metrics.bnf_validation.checks.compression_ratio.actual;
                                        useFallback = actualRatio < targetRatio;
                                    }
                                } else if (data.formatted_metrics && data.formatted_metrics.bnf_compliance) {
                                    // Secondary source: bnf_compliance
                                    isCompliant = data.formatted_metrics.bnf_compliance.is_compliant === "true";
                                    
                                    // Check compression ratio for fallback
                                    targetRatio = data.formatted_metrics.bnf_compliance.target_ratio || 0;
                                    actualRatio = data.formatted_metrics.bnf_compliance.actual_ratio || 0;
                                    useFallback = actualRatio < targetRatio;
                                } else if (data.formatted_metrics && data.formatted_metrics.bnf_compression_compliant !== undefined) {
                                    // Fallback to legacy field
                                    isCompliant = data.formatted_metrics.bnf_compression_compliant === true ||
                                                  data.formatted_metrics.bnf_compression_compliant === "true";
                                                  
                                    // Use compression ratio from data if available
                                    useFallback = data.compression_ratio && 
                                                 (data.document_type === 'heritage_document' && data.compression_ratio < 3.8) ||
                                                 (data.document_type === 'color' && data.compression_ratio < 5.7) ||
                                                 (data.document_type === 'grayscale' && data.compression_ratio < 15.2);
                                }
                                
                                // Create compliance badge
                                const badge = document.createElement('span');
                                badge.className = `badge ${isCompliant ? 'bg-success' : 'bg-danger'}`;
                                badge.textContent = isCompliant ? 'Passed' : 'Failed';
                                bnfComplianceBadgeContainer.appendChild(badge);
                                
                                // Add fallback badge if needed
                                if (isCompliant && useFallback) {
                                    const fallbackBadge = document.createElement('span');
                                    fallbackBadge.className = 'badge bg-info';
                                    fallbackBadge.setAttribute('data-bs-toggle', 'tooltip');
                                    fallbackBadge.setAttribute('title', 'This file uses lossless fallback strategy when target compression cannot be achieved without quality loss. This is BnF compliant.');
                                    fallbackBadge.textContent = 'Lossless Fallback';
                                    bnfComplianceBadgeContainer.appendChild(fallbackBadge);
                                    
                                    // Initialize the tooltip for this new element
                                    new bootstrap.Tooltip(fallbackBadge);
                                }
                            }
                        }
                    }
                }
                
                // Update compression metrics if available
                const convertedSize = document.getElementById('converted-size');
                const compressionRatio = document.getElementById('compression-ratio');
                
                if (convertedSize && data.converted_size) {
                    convertedSize.textContent = formatFileSize(data.converted_size);
                }
                
                if (compressionRatio && data.compression_ratio) {
                    compressionRatio.textContent = `${data.compression_ratio}:1`;
                }
                
                // Show error message if job failed
                if (data.status === 'failed' && data.error_message) {
                    const errorMessage = document.getElementById('error-message');
                    if (errorMessage) {
                        errorMessage.textContent = data.error_message;
                        errorMessage.style.display = 'block';
                    }
                }
                
                // Continue polling if job is not completed or failed
                if (data.status === 'pending' || data.status === 'processing') {
                    setTimeout(pollJobStatus, 2000); // Poll every 2 seconds
                } else {
                    // Refresh the page after a brief delay to get the final state
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('Error polling job status:', error);
                // Retry after a longer delay
                setTimeout(pollJobStatus, 5000);
            });
    }
    
    // File grid pagination function
    function setupFilePagination() {
        // Get all file items
        fileItems = Array.from(document.querySelectorAll('.file-item'));
        
        // Exit if no files
        if (fileItems.length === 0) return;
        
        // Set up pagination if needed
        if (fileItems.length > ITEMS_PER_PAGE) {
            const paginationContainer = document.getElementById('files-pagination');
            if (!paginationContainer) return;
            
            // Calculate total pages
            const totalPages = Math.ceil(fileItems.length / ITEMS_PER_PAGE);
            
            // Clear pagination container
            paginationContainer.innerHTML = '';
            
            // Add previous button
            const prevLi = document.createElement('li');
            prevLi.className = 'page-item ' + (currentPage === 1 ? 'disabled' : '');
            prevLi.innerHTML = '<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>';
            prevLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    goToPage(currentPage - 1);
                }
            });
            paginationContainer.appendChild(prevLi);
            
            // Add page numbers
            for (let i = 1; i <= totalPages; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = 'page-item ' + (i === currentPage ? 'active' : '');
                pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                pageLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    goToPage(i);
                });
                paginationContainer.appendChild(pageLi);
            }
            
            // Add next button
            const nextLi = document.createElement('li');
            nextLi.className = 'page-item ' + (currentPage === totalPages ? 'disabled' : '');
            nextLi.innerHTML = '<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>';
            nextLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    goToPage(currentPage + 1);
                }
            });
            paginationContainer.appendChild(nextLi);
        }
        
        // Display the first page
        goToPage(1);
    }
    
    // Go to specific page in the file grid
    function goToPage(page) {
        if (!fileItems.length) return;
        
        currentPage = page;
        
        // Calculate start and end indexes
        const startIndex = (page - 1) * ITEMS_PER_PAGE;
        const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, fileItems.length);
        
        // Hide all items
        fileItems.forEach(item => {
            item.style.display = 'none';
        });
        
        // Show only items for current page
        for (let i = startIndex; i < endIndex; i++) {
            fileItems[i].style.display = 'block';
        }
        
        // Update pagination active states
        const paginationLinks = document.querySelectorAll('#files-pagination .page-item');
        paginationLinks.forEach(link => {
            link.classList.remove('active');
        });
        
        // Update active page
        const activePage = document.querySelector(`#files-pagination .page-item:nth-child(${page + 1})`);
        if (activePage) activePage.classList.add('active');
        
        // Update prev/next buttons
        const totalPages = Math.ceil(fileItems.length / ITEMS_PER_PAGE);
        const prevBtn = document.querySelector('#files-pagination .page-item:first-child');
        const nextBtn = document.querySelector('#files-pagination .page-item:last-child');
        
        if (prevBtn) prevBtn.classList.toggle('disabled', currentPage === 1);
        if (nextBtn) nextBtn.classList.toggle('disabled', currentPage === totalPages);
    }
    
    // Setup file item selection
    function setupFileSelection() {
        // Get all file items and checkboxes
        const fileItems = document.querySelectorAll('.file-item');
        const checkboxes = document.querySelectorAll('.file-checkbox');
        const selectAllCheckbox = document.getElementById('select-all-files');
        const batchActions = document.getElementById('batch-actions');
        const batchDownloadBtn = document.getElementById('batch-download-btn');
        
        // Track selected files
        selectedFiles = [];
        
        // Add click handler to each file item
        fileItems.forEach((item, index) => {
            // Get the checkbox inside this item
            const checkbox = item.querySelector('.file-checkbox');
            
            // Make whole item clickable to select/deselect
            item.addEventListener('click', (e) => {
                // Don't trigger if clicked directly on checkbox
                if (e.target !== checkbox) {
                    checkbox.checked = !checkbox.checked;
                    
                    // Trigger change event on checkbox
                    const event = new Event('change');
                    checkbox.dispatchEvent(event);
                }
            });
            
            // Handle checkbox changes
            checkbox.addEventListener('change', () => {
                // Toggle selected class
                item.classList.toggle('selected', checkbox.checked);
                
                // Update selected files array
                const fileUrl = item.getAttribute('data-url');
                
                if (checkbox.checked) {
                    // Add to selected files if not already there
                    if (!selectedFiles.includes(fileUrl)) {
                        selectedFiles.push(fileUrl);
                    }
                } else {
                    // Remove from selected files
                    selectedFiles = selectedFiles.filter(url => url !== fileUrl);
                }
                
                // Update batch actions visibility
                batchActions.classList.toggle('show', selectedFiles.length > 0);
                
                // Update "Select All" checkbox state
                if (selectedFiles.length === checkboxes.length) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                }
            });
        });
        
        // Set up "Select All" checkbox
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', () => {
                const isChecked = selectAllCheckbox.checked;
                
                // Update all checkboxes
                checkboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                    
                    // Trigger change event
                    const event = new Event('change');
                    checkbox.dispatchEvent(event);
                });
            });
        }
        
        // Set up batch download button
        if (batchDownloadBtn) {
            batchDownloadBtn.addEventListener('click', () => {
                if (selectedFiles.length === 0) return;
                
                // Get structure preference
                const useFlatStructure = document.getElementById('flat-structure-toggle').checked;
                
                // If all files are selected, use the "Download All" URL with flat structure parameter if needed
                if (selectedFiles.length === checkboxes.length) {
                    let url = "{% url 'job_download_all' job.id %}";
                    if (useFlatStructure) {
                        url += "?flat=true";
                    }
                    window.location.href = url;
                    return;
                }
                
                // Create a form to submit selected files to the server
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{% url 'download_selected_files' %}";
                form.style.display = 'none';
                
                // Add CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                if (csrfToken) {
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrfmiddlewaretoken';
                    csrfInput.value = csrfToken.value;
                    form.appendChild(csrfInput);
                } else {
                    // If no CSRF token found, create a new one from cookie
                    function getCookie(name) {
                        let cookieValue = null;
                        if (document.cookie && document.cookie !== '') {
                            const cookies = document.cookie.split(';');
                            for (let i = 0; i < cookies.length; i++) {
                                const cookie = cookies[i].trim();
                                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                    break;
                                }
                            }
                        }
                        return cookieValue;
                    }
                    
                    const csrftoken = getCookie('csrftoken');
                    if (csrftoken) {
                        const csrfInput = document.createElement('input');
                        csrfInput.type = 'hidden';
                        csrfInput.name = 'csrfmiddlewaretoken';
                        csrfInput.value = csrftoken;
                        form.appendChild(csrfInput);
                    }
                }
                
                // Add flat structure preference
                if (useFlatStructure) {
                    const flatInput = document.createElement('input');
                    flatInput.type = 'hidden';
                    flatInput.name = 'flat';
                    flatInput.value = 'true';
                    form.appendChild(flatInput);
                }
                
                // Add each selected file URL as a form field
                selectedFiles.forEach(fileUrl => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'file_urls[]';
                    input.value = fileUrl;
                    form.appendChild(input);
                });
                
                // Add the form to the document and submit it
                document.body.appendChild(form);
                form.submit();
            });
        }
    }
    
    // Helper function to format file size
    function formatFileSize(bytes) {
        if (bytes == 0) return '0 Bytes';
        
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Initialize functions when the page is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Start polling job status
        pollJobStatus();
        
        // Set up file pagination
        setupFilePagination();
        
        // Set up file selection
        setupFileSelection();
        
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
        
        // Make file items clickable for downloading
        document.querySelectorAll('.file-item').forEach(item => {
            item.addEventListener('dblclick', (e) => {
                // Check if we're clicking on the item but not on the checkbox
                if (e.target.closest('.file-checkbox')) return;
                
                // Get file URL and trigger download
                const fileUrl = item.getAttribute('data-url');
                if (fileUrl) {
                    window.open(fileUrl, '_blank');
                }
            });
        });
    });
</script>
{% endblock %}
