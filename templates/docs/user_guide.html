{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} | JP2Forge Web{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1>JP2Forge Web User Guide</h1>
            <p class="lead">Learn how to use the JP2Forge Web application for converting images to JPEG2000 format.</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{% url 'dashboard' %}" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="list-group mb-4">
                <a href="{% url 'docs_readme' %}" class="list-group-item list-group-item-action">Documentation Home</a>
                <a href="{% url 'docs_user_guide' %}" class="list-group-item list-group-item-action active">User Guide</a>
                <a href="{% url 'about' %}" class="list-group-item list-group-item-action">About JP2Forge Web</a>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Table of Contents</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <a href="#important-note" class="list-group-item list-group-item-action">Important Note</a>
                        <a href="#creating-jobs" class="list-group-item list-group-item-action">Creating a New Conversion Job</a>
                        <a href="#compression-options" class="list-group-item list-group-item-action">Understanding Compression Options</a>
                        <a href="#document-types" class="list-group-item list-group-item-action">Document Types</a>
                        <a href="#bnf-compliance" class="list-group-item list-group-item-action">BnF Compliance Options</a>
                        <a href="#mock-mode" class="list-group-item list-group-item-action">Mock Mode Information</a>
                        <a href="#managing-jobs" class="list-group-item list-group-item-action">Viewing and Managing Jobs</a>
                        <a href="#downloading" class="list-group-item list-group-item-action">Downloading Converted Files</a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-9">
            <div class="card">
                <div class="card-body">
                    <section id="important-note" class="mb-5">
                        <h2>Important Note</h2>
                        <div class="alert alert-info">
                            <p>JP2Forge Web serves primarily as a promotional demonstration for the JP2Forge script and its BnF (Bibliothèque nationale de France) compliance capabilities. This web interface implements a curated subset of JP2Forge's full functionality, focusing on showcasing key features in an accessible way.</p>
                            <p class="mb-0">For access to all JP2Forge capabilities, users are encouraged to work directly with the <a href="https://github.com/xy-liao/jp2forge" target="_blank">JP2Forge script</a>.</p>
                        </div>
                    </section>

                    <section id="creating-jobs" class="mb-5">
                        <h2>Creating a New Conversion Job</h2>
                        <p>To create a new conversion job:</p>
                        <ol>
                            <li>Log in to your account</li>
                            <li>Navigate to the "New Job" page</li>
                            <li>Click "Choose Files" to select one or more image files to convert</li>
                            <li>Configure the conversion settings (explained below)</li>
                            <li>Click "Upload and Convert" to start the conversion process</li>
                        </ol>
                        <p>The system supports batch conversion of multiple files in one job.</p>
                        <div class="alert alert-secondary">
                            <strong>File Size Limit:</strong> The maximum allowed file size for uploads is 100MB per file. Larger files will need to be reduced before uploading.
                        </div>
                    </section>

                    <section id="compression-options" class="mb-5">
                        <h2>Understanding Compression Options</h2>
                        <p>JP2Forge offers four compression modes, each suited to different needs:</p>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h3 class="h5 mb-0">Lossless</h3>
                            </div>
                            <div class="card-body">
                                <ul>
                                    <li>Preserves all image data perfectly</li>
                                    <li>Results in larger file sizes</li>
                                    <li>Ideal for archival purposes where no quality loss is acceptable</li>
                                    <li>No quality setting is needed (automatically hidden)</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h3 class="h5 mb-0">Lossy</h3>
                            </div>
                            <div class="card-body">
                                <ul>
                                    <li>Achieves smaller files by allowing controlled quality reduction</li>
                                    <li>Quality level is adjustable (20-100)</li>
                                    <li>Good for web access copies or when storage space is limited</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h3 class="h5 mb-0">Supervised</h3>
                            </div>
                            <div class="card-body">
                                <ul>
                                    <li>Expert-level settings with fine-tuned parameters</li>
                                    <li>Allows detailed control of the compression process</li>
                                    <li>Quality level is adjustable (20-100)</li>
                                    <li>Best for specialized needs or when precise control is required</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h3 class="h5 mb-0">BnF Compliant</h3>
                            </div>
                            <div class="card-body">
                                <ul>
                                    <li>Follows Bibliothèque nationale de France digitization standards</li>
                                    <li>Specialized preservation settings for cultural heritage materials</li>
                                    <li>No quality setting is needed (automatically configured)</li>
                                    <li>When selected, the BnF Compliant checkbox is automatically checked and disabled</li>
                                </ul>
                            </div>
                        </div>
                    </section>

                    <section id="document-types" class="mb-5">
                        <h2>Document Types</h2>
                        <p>Select the document type that best matches your source material:</p>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h3 class="h5 mb-0">Photograph</h3>
                            </div>
                            <div class="card-body">
                                <ul>
                                    <li>Optimized for detailed photos and continuous-tone images</li>
                                    <li>Special handling for detail preservation in high frequencies</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h3 class="h5 mb-0">Heritage Document</h3>
                            </div>
                            <div class="card-body">
                                <ul>
                                    <li>Best for historical manuscripts, documents, and maps</li>
                                    <li>Emphasizes text clarity and detail preservation</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h3 class="h5 mb-0">Color</h3>
                            </div>
                            <div class="card-body">
                                <ul>
                                    <li>Optimized for vibrant color content and general graphics</li>
                                    <li>Enhanced color fidelity</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h3 class="h5 mb-0">Grayscale</h3>
                            </div>
                            <div class="card-body">
                                <ul>
                                    <li>Best for black & white or grayscale content</li>
                                    <li>Focuses on contrast preservation</li>
                                </ul>
                            </div>
                        </div>
                    </section>

                    <section id="bnf-compliance" class="mb-5">
                        <h2>BnF Compliance Options</h2>
                        <p>There are two ways to apply BnF (Bibliothèque nationale de France) standards:</p>
                        
                        <ol>
                            <li><strong>BnF Compliant Compression Mode</strong>: Select "BnF Compliant" from the compression mode dropdown. This applies all BnF standards as a complete preset and automatically checks the BnF Compliant checkbox.</li>
                            <li><strong>BnF Compliant Checkbox</strong>: When using other compression modes (Lossless, Lossy, or Supervised), you can enable this checkbox to apply BnF standards while maintaining your selected compression approach.</li>
                        </ol>
                        
                        <div class="alert alert-info">
                            <h4 class="h5">Key Difference:</h4>
                            <ul>
                                <li>The BnF Compliant mode applies a comprehensive set of BnF specifications</li>
                                <li>The checkbox option allows you to apply BnF standards while using your preferred compression mode</li>
                            </ul>
                        </div>
                        
                        <h3 class="h5 mt-4">Understanding BnF Compliance Reports</h3>
                        <div class="card mb-3">
                            <div class="card-body">
                                <p>When viewing job details for BnF-compliant conversions, you'll see three important indicators:</p>
                                
                                <ol>
                                    <li>
                                        <strong>BnF Mode</strong>: Indicates whether BnF compliance was requested when creating the job. This is simply a record of your selection during job creation.
                                        <div class="mt-2 mb-3">
                                            <span class="badge" style="background-color: #0d6efd; color: #fff; padding: 6px 10px; border-radius: 4px; font-size: 0.875rem;">Auto</span> 
                                            <span class="text-muted small ms-2">When the BnF Compliant compression mode was selected</span>
                                        </div>
                                        <div class="mb-3">
                                            <span class="badge" style="background-color: #0d6efd; color: #fff; padding: 6px 10px; border-radius: 4px; font-size: 0.875rem;">Manual</span> 
                                            <span class="text-muted small ms-2">When BnF compliance was added to another compression mode</span>
                                        </div>
                                    </li>
                                    <li>
                                        <strong>BnF Compliance</strong>: Shows whether the final output meets BnF standards overall. This can show "Passed" even when the target compression ratio wasn't achieved directly, because BnF standards allow for a lossless fallback strategy.
                                        <div class="mt-2 mb-3">
                                            <span class="badge" style="background-color: #198754; color: #fff; padding: 6px 10px; border-radius: 4px; font-size: 0.875rem;">Passed</span> 
                                            <span class="badge ms-2" style="background-color: #6c757d; color: #fff; padding: 6px 10px; border-radius: 4px; font-size: 0.875rem; opacity: 0.85;">Lossless Fallback</span> 
                                            <span class="text-muted small ms-2">Indicates compliance was achieved, possibly using fallback</span>
                                        </div>
                                        <div class="mb-3">
                                            <span class="badge" style="background-color: #dc3545; color: #fff; padding: 6px 10px; border-radius: 4px; font-size: 0.875rem;">Failed</span> 
                                            <span class="text-muted small ms-2">When the output does not meet BnF standards</span>
                                        </div>
                                    </li>
                                    <li>
                                        <strong>Target Ratio</strong>: Indicates whether the specific compression ratio target was achieved directly. This shows the relationship between your actual compression ratio and the target ratio for your document type.
                                        <div class="mt-2 mb-3">
                                            <span class="badge" style="background-color: #198754; color: #fff; padding: 6px 10px; border-radius: 4px; font-size: 0.875rem;">Yes</span> 
                                            <span class="badge ms-2" style="background-color: #6c757d; color: #fff; padding: 6px 10px; border-radius: 4px; font-size: 0.875rem; opacity: 0.85;">10.5:1 ≥ 6:1</span>
                                            <span class="text-muted small ms-2">When target ratio was achieved</span>
                                        </div>
                                        <div class="mb-3">
                                            <span class="badge" style="background-color: #dc3545; color: #fff; padding: 6px 10px; border-radius: 4px; font-size: 0.875rem;">No</span> 
                                            <span class="badge ms-2" style="background-color: #6c757d; color: #fff; padding: 6px 10px; border-radius: 4px; font-size: 0.875rem; opacity: 0.85;">3.2:1 < 6:1</span>
                                            <span class="text-muted small ms-2">When target ratio was not achieved</span>
                                        </div>
                                    </li>
                                </ol>
                                
                                <p>For complete compliance information, the job detail page may show a "Lossless Fallback" indicator. This means:</p>
                                
                                <ul>
                                    <li>The system first attempted to achieve the target compression ratio using lossy compression</li>
                                    <li>The target ratio couldn't be achieved without compromising quality</li>
                                    <li>The system automatically fell back to lossless compression to preserve image quality</li>
                                    <li>This fallback is fully compliant with BnF standards, which is why the overall compliance shows "Passed"</li>
                                </ul>
                                
                                <div class="alert alert-info mb-0">
                                    <p class="mb-0">This automatic fallback mechanism is specifically mentioned in the BnF documentation to prevent excessive information loss for images that don't compress well with lossy methods.</p>
                                </div>
                            </div>
                        </div>

                        <h3 class="h5 mt-4">BnF Reference Documentation</h3>
                        <p>The implementation follows standards defined in these official BnF documents:</p>
                        <ul>
                            <li><strong>BnF Referential (2015)</strong>: <a href="https://www.bnf.fr/sites/default/files/2018-11/ref_num_fichier_image_v2.pdf" target="_blank">Référentiel de format de fichier image v2</a></li>
                            <li><strong>BnF Documentation (2021)</strong>: <a href="https://www.bnf.fr/sites/default/files/2021-04/politiqueFormatsDePreservationBNF_20210408.pdf" target="_blank">Formats de données pour la préservation à long terme</a></li>
                        </ul>

                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Document Type</th>
                                        <th>BnF Notation</th>
                                        <th>Standard Notation</th>
                                        <th>Option</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Photograph</td>
                                        <td>1:4</td>
                                        <td>4:1</td>
                                        <td><code>document_type=photograph</code></td>
                                    </tr>
                                    <tr>
                                        <td>Heritage Document</td>
                                        <td>1:4</td>
                                        <td>4:1</td>
                                        <td><code>document_type=heritage_document</code></td>
                                    </tr>
                                    <tr>
                                        <td>Color</td>
                                        <td>1:6</td>
                                        <td>6:1</td>
                                        <td><code>document_type=color</code></td>
                                    </tr>
                                    <tr>
                                        <td>Grayscale</td>
                                        <td>1:16</td>
                                        <td>16:1</td>
                                        <td><code>document_type=grayscale</code></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <section id="mock-mode" class="mb-5">
                        <h2>Mock Mode Information</h2>
                        <p>JP2Forge Web includes a testing/development feature called "Mock Mode" which can be enabled by setting <code>JP2FORGE_MOCK_MODE=True</code> in your <code>.env</code> file.</p>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h3 class="h5 mb-0">What Mock Mode Does</h3>
                            </div>
                            <div class="card-body">
                                <p>When mock mode is enabled, JP2Forge Web simulates the conversion process without requiring the actual JP2Forge library:</p>
                                <ol>
                                    <li>Files are <strong>not</strong> truly converted to JPEG2000 format - they are merely copied or small placeholder files are created</li>
                                    <li>The resulting files with <code>.jp2</code> extension are <strong>not valid JPEG2000 files</strong> and lack the expected compression benefits</li>
                                    <li>The system generates fictitious quality metrics (PSNR, SSIM) and compression ratios for display purposes</li>
                                    <li>All the web interface functionality can be tested without the actual conversion engine</li>
                                </ol>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h3 class="h5 mb-0">When to Use Mock Mode</h3>
                            </div>
                            <div class="card-body">
                                <p>Mock mode is appropriate for:</p>
                                <ul>
                                    <li>UI development work on JP2Forge Web</li>
                                    <li>Testing the application flow without installing the JP2Forge library</li>
                                    <li>Demonstration purposes when actual conversion functionality is not needed</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h3 class="h5 mb-0">Limitations of Mock Mode</h3>
                            </div>
                            <div class="card-body">
                                <p>Important limitations to be aware of:</p>
                                <ul>
                                    <li>Files are not actually compressed - they remain their original size or become small placeholders</li>
                                    <li>Image information is not preserved in any meaningful way</li>
                                    <li>The output files cannot be viewed as JPEG2000 images by other software</li>
                                    <li>Reported statistics are simulated, not real measurements</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h3 class="h5 mb-0">Identifying Mock Mode</h3>
                            </div>
                            <div class="card-body">
                                <p>When mock mode is active, the following indicators appear:</p>
                                <ul>
                                    <li>A notice appears on the status page indicating mock mode</li>
                                    <li>Job history shows mock conversions labeled as such</li>
                                    <li>Log files record that mock mode is being used</li>
                                </ul>
                                <div class="alert alert-warning">
                                    <p class="mb-0">For actual JPEG2000 conversion, you must disable mock mode and ensure the JP2Forge library is properly installed and configured.</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section id="managing-jobs" class="mb-5">
                        <h2>Viewing and Managing Jobs</h2>
                        <p>After submitting a conversion job:</p>
                        <ol>
                            <li>You'll be redirected to the job detail page</li>
                            <li>The status will initially show as "Pending" or "Processing"</li>
                            <li>Refresh the page or wait for automatic updates to see progress</li>
                            <li>Once completed, the status will change to "Completed" and download links will appear</li>
                        </ol>
                        
                        <p>From the "My Jobs" page, you can:</p>
                        <ul>
                            <li>View all your conversion jobs</li>
                            <li>Filter jobs by status</li>
                            <li>Sort by different criteria</li>
                            <li>Delete completed jobs you no longer need</li>
                        </ul>
                    </section>

                    <section id="downloading" class="mb-5">
                        <h2>Downloading Converted Files</h2>
                        <p>After a job completes successfully:</p>
                        <ol>
                            <li>Go to the job detail page</li>
                            <li>Click the "Download" button next to each converted file</li>
                            <li>For multi-page documents, you'll see individual download links for each page</li>
                        </ol>
                        
                        <div class="alert alert-secondary">
                            <p class="mb-0">Converted files are kept available for download for 30 days by default.</p>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}